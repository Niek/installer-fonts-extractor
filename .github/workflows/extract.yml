name: Extract Windows fonts
on: [push, pull_request]

jobs:
  extract-and-upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v2
      - name: Install dependencies
        run: |
          curl -sL https://deb.nodesource.com/setup_14.x | sudo -E bash -
          sudo apt-get install -y nodejs wimtools curl
          npm i playwright-chromium
      - name: Fetch Windows 10 ISO
        run: |
          LINK=$(node link.js)
          echo "Downloading Windows 10 ISO from link: ${LINK}"
          curl -s "${LINK}" -o win10.iso
          ls -lha win10.iso
      - name: Extract fonts
        run: |
          mkdir mount
          sudo mount win10.iso mount -o loop
          wimextract mount/sources/install.wim 1 /Windows/{Fonts/"*".{ttf,ttc},System32/Licenses/neutral/"*"/"*"/license.rtf} --dest-dir fonts
          sudo umount mount
      - name: Upload fonts artifact
        uses: actions/upload-artifact@v2
        with:
          name: Windows 10 fonts
          path: fonts/
      - name: Clean up
        run: |
          rm -rf node_modules/ win10.iso fonts/ mount/